<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--NOTICE: Please open this file in your web browser. If presented with a security warning, you may safely tell it to allow the blocked content.-->
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD.\nAlthough MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD.\nNo support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="https://www.phpbb.com/mods/xml/modx-1.2.6.xsd">
	<header>
		<license><![CDATA[http://opensource.org/licenses/gpl-license.php GNU General Public License v2]]></license>
		<title lang="en"><![CDATA[Oauthorize Internal MOD]]></title>
		<description lang="en"><![CDATA[Add links between user accounts and Internal accounts, enabling
- an automatic authentication with  Internal
- registration]]></description>
		<author-notes lang="en"><![CDATA[
    Installation is set at intermediate level because there are manual tasks to be done at the end of the normal installation process, especially 
    - the registration of your site as an application on Internal.
    - the creation of 2 custom profile fields via your Administration Control Panel   
    I assume, that if you know how to register a Faceboook and a Internal application to get your application credentials, you will manage to create custom profile fields and edit the 2 files at the end of the installation to enter the keys. An integration within Administration Control Panel to avoid the edit of last 2 files, may be implemented in the future but it works as it today ;)
    You can get the official code for this mod from https://github.com/pazufr/oauthorize     
    This mod is derived from OAuthorize phpBB still in DEV status by Paolo Umali.       
    ]]></author-notes>
		<github><![CDATA[https://github.com/pazufr/oauthorize]]></github>
		<author-group>
			<author>
				<realname><![CDATA[Thierry Pazu]]></realname>
				<username><![CDATA[Pazufr]]></username>
				<homepage><![CDATA[http://www.animint.com]]></homepage>
			</author>
		</author-group>
		<mod-version>1.0</mod-version>
		<installation>
			<level>intermediate</level>
			<time>1200</time>
			<target-version>3.0.11</target-version>
		</installation>
	</header>
	<action-group>
    <sql><![CDATA[ALTER TABLE phpbb_sessions ADD COLUMN session_oauth VARCHAR(255) NOT NULL;
ALTER TABLE phpbb_sessions ALTER COLUMN session_oauth SET DEFAULT '';]]></sql>
    <copy>
      <file from="root/includes/hooks/hook_oauthorize.php" to="includes/hooks/hook_oauthorize.php"/>
      <file from="root/includes/auth/auth_oauth.php" to="includes/auth/auth_oauth.php"/>
      <file from="root/language/en/mods/oauthorize.php" to="language/en/mods/oauthorize.php"/>
			<file from="root/oauthorize.php" to="oauthorize.php"/>
			<file from="root/oauthorize/index.html" to="oauthorize/index.html"/>
      <file from="root/oauthorize/functions_oauthorize.php" to="oauthorize/functions_oauthorize.php"/>
			<file from="root/oauthorize/facebook/index.html" to="oauthorize/facebook/index.html"/>
			<file from="root/oauthorize/facebook/base_facebook.php" to="oauthorize/facebook/base_facebook.php"/>
			<file from="root/oauthorize/facebook/facebook.php" to="oauthorize/facebook/facebook.php"/>
			<file from="root/oauthorize/facebook/fb_ca_chain_bundle.crt" to="oauthorize/facebook/fb_ca_chain_bundle.crt"/>
      <file from="root/oauthorize/internal/index.html" to="oauthorize/internal/index.html"/>
			<file from="root/oauthorize/internal/internaloauth.php" to="oauthorize/internal/internaloauth.php"/>
			<file from="root/oauthorize/internal/OAuth.php" to="oauthorize/internal/OAuth.php"/>
			<file from="root/oauthorize/internal/cacert.pem" to="oauthorize//internal/cacert.pem"/>
			<file from="root/styles/prosilver/template/oauthorize_links.html" to="styles/prosilver/template/oauthorize_links.html"/>      
			<file from="root/styles/prosilver/theme/oauthorize.css" to="styles/prosilver/theme/oauthorize.css"/>
      <file from="root/styles/prosilver/theme/images/oauth_icon.png" to="styles/prosilver/theme/images/oauth_icon.png"/>			     
		</copy>
    <open src="styles/prosilver/template/overall_header.html">
      <edit>
        <find><![CDATA[				<li class="icon-faq"><a href="{U_FAQ}" title="{L_FAQ_EXPLAIN}">{L_FAQ}</a></li>]]></find>
				<action type="before-add"><![CDATA[<!-- INCLUDE oauthorize_links.html -->]]></action>
      </edit>
    </open>
    <open src="styles/prosilver/theme/stylesheet.css">
			<edit>
				<find><![CDATA[@import url("colours.css");]]></find>
				<action type="after-add"><![CDATA[@import url("oauthorize.css");]]></action>
			</edit>
		</open>
    <diy-instructions lang="en"><![CDATA[Next steps
    
The following final steps are _MANDATORY_ to enable this MOD on your forum

2. Create a Internal application and note your consumer key and secret

See https://dev.internal.com/ for instructions

3. Edit manualy the file 'oauthorize.php'

Put your own Internal and Facebook keys

Replace 'wwwwwwwwww' with your Internal application key
Replace 'zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz' with your Internal application secret key

$providers = array(

	'facebook' => array(
		'id'     => 'xxxxxxxxxx',
		'secret' => 'yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy',
	),
	'internal' => array(
		'key'    => 'wwwwwwwwww',
		'secret' => 'zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz',		
	),
);

6.  Custom profile fields creation  for Internal

Go to the Administration Control Panel
Choose 'Users and Groups' tabs
Click on 'Custom profile fields' in the menu on the left
Create a new field 'oauth_internal_id' in 'Single text field'
Check the 'display on registration screen' option
Default value: 0
Click on Profil type specific options button
Lenght of input box: 30
Minimum number of characters: 0
Field validation: Only number
Click on "Save"

7. Purge cache via the Administration Control Panel

]]></diy-instructions>
  </action-group>
</mod>